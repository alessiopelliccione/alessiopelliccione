name: Update Portfolio Dashboard

on:
  schedule:
    - cron: '0 8 * * *'
  workflow_dispatch:

jobs:
  update-issue:
    runs-on: ubuntu-latest
    permissions:
      issues: write
    steps:
      - name: Generate Dashboard
        uses: actions/github-script@v7
        env:
          SEARCH_TOKEN: ${{ secrets.CONTRIBUTION_UPDATE_TOKEN }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const ISSUE_NUMBER = 1; 
            const USERNAME = context.repo.owner;
            const { Octokit } = require("@octokit/rest");
            
            const searchOctokit = new Octokit({ auth: process.env.SEARCH_TOKEN });
            
            const query = `is:pr author:${USERNAME} is:public -repo:${USERNAME}/${context.repo.repo} sort:created-desc`;
            console.log(`Searching with PAT: ${query}`);

            const result = await searchOctokit.search.issuesAndPullRequests({
              q: query,
              per_page: 50 
            });

            let prs = result.data.items;
            console.log(`Raw PRs found: ${prs.length}`);

            // --- FILTERING LOGIC ---
            prs = prs.filter(pr => {
              const isAngular = pr.html_url.toLowerCase().includes('angular');
              
              const isMerged = !!pr.pull_request.merged_at;
              const isOpen = pr.state === 'open';
              
              return isAngular && (isMerged || isOpen);
            });
            
            prs = prs.slice(0, 20);
            console.log(`Filtered Angular PRs: ${prs.length}`);

            // --- CLEANER & FORMATTER ---
            const cleanTitle = (title) => {
              let clean = title.replace(/^(fix|feat|docs|refactor|chore|style|perf|test|ci)(\(.*\))?!?:?\s*/, '');
              return clean.charAt(0).toUpperCase() + clean.slice(1).replace(/\|/g, '-');
            };

            const getStatus = (pr) => {
              if (pr.pull_request.merged_at) return 'ðŸŸ¢ Merged';
              if (pr.state === 'closed') return 'ðŸ”´ Closed'; 
              return 'ðŸŸ¡ In Review';
            };

            const getRepoName = (url) => {
               const parts = url.split('/');
               return parts[parts.length - 4] + '/' + parts[parts.length - 3];
            };

            const tableRows = prs.map(pr => {
              const repo = getRepoName(pr.html_url);
              const desc = cleanTitle(pr.title);
              const link = `[#${pr.number}](${pr.html_url})`;
              const status = getStatus(pr);
              
              const repoDisplay = `**${repo}**`;

              return `| ${repoDisplay} | ${desc} | ${link} | ${status} |`;
            }).join('\n');

            const issueBody = `
            This issue tracks my significant contributions to the **Angular Ecosystem**.
            
            ### ðŸ›  Angular Contributions Dashboard (Fully Automated)
            
            | Repo / Project | Description | Link | Status |
            | :--- | :--- | :---: | :---: |
            ${tableRows}
            
            ---
            > *Last updated: ${new Date().toUTCString()}*
            `;

            await github.rest.issues.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ISSUE_NUMBER,
              body: issueBody
            });
