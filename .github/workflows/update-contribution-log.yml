name: Update Contributions Dashboard

on:
  schedule:
    - cron: '0 8 * * *' # Runs every day at 8:00 AM UTC
  workflow_dispatch: # Allows manual trigger from Actions tab

jobs:
  update-issues:
    runs-on: ubuntu-latest
    permissions:
      issues: write # Grants write permission to the default GITHUB_TOKEN
    steps:
      # 1. SETUP: Install the necessary library to use it in the script below
      - name: Install dependencies
        run: npm install @octokit/rest

      # 2. EXECUTE SCRIPT
      - name: Generate Dashboards
        uses: actions/github-script@v7
        env:
          # We pass the Personal Access Token as an environment variable
          # This token is used ONLY for reading public PRs from other repos
          SEARCH_TOKEN: ${{ secrets.CONTRIBUTION_UPDATE_TOKEN }}
        with:
          # We use the default GITHUB_TOKEN to update the issue in THIS repo
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const USERNAME = context.repo.owner;
            
            // Import the library installed in the previous step
            const { Octokit } = require("@octokit/rest");
            
            // Create a "Search Client" using your Personal Access Token
            const searchOctokit = new Octokit({ auth: process.env.SEARCH_TOKEN });
            
            // Query: Public PRs authored by you, excluding this profile repo
            const query = `is:pr author:${USERNAME} is:public -repo:${USERNAME}/${context.repo.repo} sort:created-desc`;
            console.log(`Searching with PAT: ${query}`);

            // Fetch 50 PRs to ensure we have enough after filtering
            const result = await searchOctokit.search.issuesAndPullRequests({
              q: query,
              per_page: 50 
            });

            const allPrs = result.data.items;
            console.log(`Raw PRs found: ${allPrs.length}`);

            // --- FORMATTING HELPERS ---
            const cleanTitle = (title) => {
              // Removes conventional commit prefixes (e.g., "fix(core):")
              let clean = title.replace(/^(fix|feat|docs|refactor|chore|style|perf|test|ci)(\(.*\))?!?:?\s*/, '');
              // Capitalize first letter and replace pipes to avoid breaking Markdown tables
              return clean.charAt(0).toUpperCase() + clean.slice(1).replace(/\|/g, '-');
            };

            const getStatus = (pr) => {
              if (pr.pull_request.merged_at) return 'ðŸŸ¢ Merged';
              if (pr.state === 'closed') return 'ðŸ”´ Closed'; 
              return 'ðŸŸ¡ In Review';
            };

            const getRepoName = (url) => {
               // Extracts "owner/repo" from URL
               const parts = url.split('/');
               return parts[parts.length - 4] + '/' + parts[parts.length - 3];
            };

            // Generic function to update an issue for a specific ecosystem
            const updateEcosystemIssue = async (issueNumber, ecosystemName, filterKeyword) => {
              // Filter PRs for this ecosystem
              let prs = allPrs.filter(pr => {
                const matchesEcosystem = pr.html_url.toLowerCase().includes(filterKeyword);
                const isMerged = !!pr.pull_request.merged_at;
                const isOpen = pr.state === 'open';
                return matchesEcosystem && (isMerged || isOpen);
              });
              
              // Keep only the top 20 after filtering
              prs = prs.slice(0, 20);
              console.log(`Filtered ${ecosystemName} PRs: ${prs.length}`);

              // Build Markdown table rows
              const tableRows = prs.map(pr => {
                const repo = getRepoName(pr.html_url);
                const desc = cleanTitle(pr.title);
                const link = `[#${pr.number}](${pr.html_url})`;
                const status = getStatus(pr);
                const repoDisplay = `**${repo}**`;
                return `| ${repoDisplay} | ${desc} | ${link} | ${status} |`;
              }).join('\n');

              const issueBody = `
              This issue tracks my significant contributions to the **${ecosystemName} Ecosystem**.
              
              ### ðŸ›  ${ecosystemName} Contributions Dashboard (Fully Automated)
              
              | Repo / Project | Description | Link | Status |
              | :--- | :--- | :---: | :---: |
              ${tableRows}
              
              ---
              > *Last updated: ${new Date().toUTCString()}*
              `;

              // Update the issue
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                body: issueBody
              });
              
              console.log(`âœ… Updated issue #${issueNumber} for ${ecosystemName}`);
            };

            // Update both ecosystems
            await updateEcosystemIssue(1, 'Angular', 'angular');
            await updateEcosystemIssue(2, 'Nx', 'nrwl');
