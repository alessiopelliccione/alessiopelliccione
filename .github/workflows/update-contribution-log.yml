name: Update Portfolio Dashboard

on:
  schedule:
    - cron: '0 8 * * *' # Runs every day at 8:00 AM UTC
  workflow_dispatch: # Allows manual trigger from the Actions tab

jobs:
  update-issue:
    runs-on: ubuntu-latest
    permissions:
      issues: write # Required to modify the issue body
    steps:
      - name: Generate and Update Dashboard
        uses: actions/github-script@v7
        with:
          script: |
            // --- CONFIGURATION ---
            const ISSUE_NUMBER = 1; // Target Issue ID
            const USERNAME = context.repo.owner;
            const MAX_PRS = 20; // Max number of PRs to display
            
            // --- QUERY CONSTRUCTION ---
            // Find public PRs created by the user, excluding the profile repo itself
            // Sorted by creation date (newest first)
            const query = `is:pr author:${USERNAME} is:public -repo:${USERNAME}/${context.repo.repo} sort:created-desc`;
            
            console.log(`Searching for PRs with query: ${query}`);

            // --- FETCH DATA ---
            const result = await github.rest.search.issuesAndPullRequests({
              q: query,
              per_page: MAX_PRS
            });

            const prs = result.data.items;
            console.log(`Found ${prs.length} PRs.`);

            // --- HELPERS ---
            
            // Determine status icon based on PR state
            const getStatus = (pr) => {
              if (pr.pull_request.merged_at) return 'ðŸŸ¢ Merged';
              if (pr.state === 'closed') return 'ðŸ”´ Closed';
              return 'ðŸŸ¡ In Review'; // Open state
            };

            // Extract clean repo name (e.g., "angular/angular")
            const getRepoName = (url) => {
               // Url format: https://github.com/owner/repo/pull/123
               const parts = url.split('/');
               return parts[parts.length - 4] + '/' + parts[parts.length - 3];
            };

            // --- BUILD MARKDOWN TABLE ---
            const tableRows = prs.map(pr => {
              const repo = getRepoName(pr.html_url);
              
              // Sanitize title (remove pipes to avoid breaking Markdown table)
              const desc = pr.title.replace(/\|/g, '-'); 
              
              const link = `[#${pr.number}](${pr.html_url})`;
              const status = getStatus(pr);
              
              // Highlight high-impact repos (Angular ecosystem)
              const isHighImpact = repo.includes('angular') || repo.includes('google');
              const repoDisplay = isHighImpact ? `**${repo}**` : repo;

              return | ${repoDisplay} | ${desc} | ${link} | ${status} |;
            }).join('\n');

            // --- ASSEMBLE ISSUE BODY ---
            const issueBody = `
            This issue tracks my significant contributions to Open Source, with a focus on the **Angular** ecosystem.
            
            ### ðŸ›  Contribution Dashboard (Auto-updated)
            
            | Repo / Project | Description | Link | Status |
            | :--- | :--- | :---: | :---: |
            ${tableRows}
            
            ---
            > *This dashboard is automatically updated daily via GitHub Actions.*
            `;

            // --- UPDATE THE ISSUE ---
            await github.rest.issues.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ISSUE_NUMBER,
              body: issueBody
            });
